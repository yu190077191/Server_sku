@using WF.BusinessRule;
@using WF.Framework;
@using WF.Framework.Helper;
@using WF.Model;
@using WF.Web.Controllers;

@model List<Field>

@{
    ViewBag.Title = Model[0].VendorName;
    Field rv = new Field
    {
        Id = Model[0].RequestId,
        State = Model[0].State,
        RequestId = Model[0].RequestId,
        CreatedBy = Model[0].CreatedBy,
        RequiredIsEmpty = false,
        Email = Model[0].Email
    };

    var emptyFields = Model.Where(k => string.IsNullOrEmpty(k.Value) && string.IsNullOrEmpty(k.Files));
    if (emptyFields != null && emptyFields.Count() > 0)
    {
        //rv.RequiredIsEmpty = true;
    }

    string isApproverEdit = "false";// rv.ModifiedBy != Operation.OperationBy ? "true" : "false";
    WorkFlowAPIController api = new WorkFlowAPIController();
    Employee requester = Operation.Employee;
    List<Nestle.WorkFlow.Model.ActionHistory> historyList = ViewBag.historyList as List<Nestle.WorkFlow.Model.ActionHistory>;// api.GetApprovers(rv.RequestId, rv.Id);
    List<Nestle.WorkFlow.Model.Button> buttonList = ViewBag.ButtonList as List<Nestle.WorkFlow.Model.Button>;
    List<string> buttonNames = buttonList.Select(k => k.EventName).ToList();
    int eventId = buttonList != null && buttonList.Count > 0 ? buttonList[0].EventId : 0;
    int workFlowId = buttonList != null && buttonList.Count > 0 ? buttonList[0].WorkFlowId : 0;
    List<Attachment> commonAttachmentList = ViewBag.WriteOffAttachmentList as List<Attachment>;
    Nestle.WorkFlow.Model.ActionHistory historyListLast = historyList.LastOrDefault(k => k.Time != null);
    string stepName = string.Empty;
    bool MDC_Completed = false;
    bool MDC_Input_Completed = false;
    bool Trigger_inSAP_Completed = false;
    if (historyList != null && historyList.Count > 0)
    {
        var pending = historyList.Where(k => k.IsCurrent && k.EmployeeId == Operation.OperationBy);
        if (pending != null && pending.Count() > 0)
        {
            ViewBag.Pending = pending.ToList();
            stepName = pending.First().StepName;
        }

        var mdc_input = historyList.Where(k => k.Time != null && k.StepName == "MDC input SKU Code and Description");
        if (mdc_input != null && mdc_input.Count() > 0)
        {
            MDC_Input_Completed = true;
        }

        var Trigger_inSAP = historyList.Where(k => k.Time != null && k.StepName == "Trigger workflow for SDR 1st circle in SAP");
        if (Trigger_inSAP != null && Trigger_inSAP.Count() > 0)
        {
            Trigger_inSAP_Completed = true;
        }

        var mdc = historyList.Where(k => k.Time != null && k.StepName == "MDC" && k.CheckResult=="Return");
        if (mdc != null && mdc.Count() > 0)
        {
            MDC_Completed = true;
        }
    }

    bool isMDC = WorkFlowAPIController.IsInRole("MDC");
    List<SAPEmail> sapEmailList = ViewBag.SAPEmail as List<SAPEmail>;
}
@section Header{
    <link href="@(Url.Content("~/Content/themes/requester.css?" + DateTime.Now.ToString()))" rel="stylesheet" media="screen"
          type="text/css" />
    <link href="@(Url.Content("~/Content/themes/Blue/css/styles.css?" + DateTime.Now.ToString()))" rel="stylesheet" media="screen"
          type="text/css" />
    <link href="@(Url.Content("~/Content/MultiSelect.css?" + DateTime.Now.ToString()))" rel="stylesheet" media="screen"
          type="text/css" />
    <script type="text/javascript" src="@(Url.Content("~/Scripts/Constants.js?" + DateTime.Now.ToString()))"></script>
    <script type="text/javascript" src="@(Url.Content("~/Scripts/WorkFlow.js?" + DateTime.Now.ToString()))"></script>
    <script type="text/javascript" src="@(Url.Content("~/Scripts/Common/field.js?" + DateTime.Now.ToString()))"></script>
    <script type="text/javascript" src="@(Url.Content("~/Scripts/Common/preview.js?" + DateTime.Now.ToString()))"></script>

    <script type="text/javascript" src="@Url.Content("~/Scripts/layer/layer.js")"></script>
    <style type="text/css">
        .tdLeft3 {
            width: 30%;
        }

        .tdRight3 {
            width: 70%;
        }

        .input {
            width: 200px;
        }

        textarea {
            width: 450px;
            height: 100px;
        }

        .selectControl {
            width: 200px;
        }

        .file {
            height: 24px;
            width: 350px;
            margin-right: 10px;
        }

        .tip {
        }

        .bankdata2 {
            display: none;
        }
    </style>
}


<div class="main" style="padding:0;color:black;">
    <div class="main" style="padding-top:10px;">
        @if (!string.IsNullOrEmpty(Model[0].ContractNumber))
        {
            <div>
                合同编号：@(Model[0].ContractNumber)
                <a style="color:blue;text-decoration:underline;cursor:pointer;" onclick="createWord(@(Request.QueryString["id"].ToString()));">[下载]</a>
            </div>
        }
    <div style="margin-bottom:10px;">
        <span id="xbdType" data-Type="@(Model[0].RequestType)" style="width:282px;display:inline-block;">Type: @(Model[0].RequestType)</span>
        <span>Related links: </span><a href="@(Model[0].RelatedLink)">@(Model[0].RelatedLink)</a>
        @{
            string f190value = "";
            string f26value = "";
            string f27value = "";
            Field f190 = Model.SingleOrDefault(q => q.Id == 190);
            if (f190 != null)
            {
                f190value = f190.Value;
            }
            Field f26 = Model.SingleOrDefault(q => q.Id == 26);
            if (f26 != null)
            {
                f26value = f26.Value.ToString();
            }
            Field f27 = Model.SingleOrDefault(q => q.Id == 27);
            if (f27 != null)
            {
                f27value = f27.Value.ToString();
            }
            if ((stepName.ToLower().TrimStart().TrimEnd().Contains("Final Validation".ToLower()) && f190value.Contains("Yes") && f26value != "" && f27value != "") || stepName.ToLower().TrimStart().TrimEnd().Contains("Final Validation".ToLower()) && f190value.Contains("No"))
            {
                <input type="hidden" id="FV" value="true" />
            }
            else
            {
                <input type="hidden" id="FV" value="false" />
            }
            <input type="hidden" id="FVstepName" value="@(stepName.ToLower().TrimStart())" />
        }



    </div>
        <div id="formDiv">
            @{ Html.RenderPartial("PartialVendorPreview", Model); }
        </div>
    </div>
    <div class="main" style="margin-top:0;padding-top:0;">
        <table class="tbl" border="0" cellpadding="0" cellspacing="0">
            <thead>
                <tr>
                    <th colspan="7" align="left" style="background:#efefef;font-size:14px;">
                        @Html.Lang("Workflow Status:")
                        @if ((Nestle.WorkFlow.Model.RequestStatus)rv.State == Nestle.WorkFlow.Model.RequestStatus.Approved)
                        {
                            <b style="color:green;">@Html.Lang(((Nestle.WorkFlow.Model.RequestStatus)rv.State).ToString())</b>
                        }
                        else
                        {
                            <b style="color:red;">@Html.Lang(((Nestle.WorkFlow.Model.RequestStatus)rv.State).ToString())</b>
                        }
                    </th>
                </tr>
            </thead>
            <tr>
                @*<td>
                        @Html.Lang("Sequence")
                    </td>*@
                <td>
                    @Html.Lang("Step Name")
                </td>
                <td>
                    @Html.Lang("Title")
                </td>
                <td>
                    @Html.Lang("Name")
                </td>
                <td>
                    @Html.Lang("Review Result")
                </td>
                <td>
                    @Html.Lang("Review Comment")
                </td>
                <td>
                    @Html.Lang("Review Time")
                </td>
            </tr>

            @{
                bool someApproversMissing = false;
                bool needAutoFixWorkFlow = false;
                if (historyList != null)
                {
                    int sequence = 0;
                    foreach (Nestle.WorkFlow.Model.ActionHistory approver in historyList)
                    {
                        string checkResult = string.Empty;
                        if (!string.IsNullOrEmpty(approver.CheckResult))
                        {
                            if (approver.CheckResult.Contains("Add"))
                            {
                                checkResult = " <b style='color:green;'>" + approver.CheckResult + "</b>";
                                needAutoFixWorkFlow = true;
                            }
                            else if (approver.CheckResult.Contains("Delete"))
                            {
                                checkResult = " <b style='color:red;'>" + approver.CheckResult + "</b>";
                                needAutoFixWorkFlow = true;
                            }
                            else
                            {
                                checkResult = approver.CheckResult;
                            }
                        }

                        if (approver.RowNumber > 1)
                        {
                            //continue;
                        }

                        if (approver.IsTeamReview && !string.IsNullOrEmpty(approver.Note))
                        {
                            approver.Name = approver.Note;
                        }

                        sequence++;

                        if (approver.IsManuallyAdded)
                        {
                            if (!string.IsNullOrEmpty(approver.Remark))
                            {
                                approver.StepName += " (Message: <b style='font-weight:bold;'>" + approver.Remark + "</b>)";
                                approver.Remark = string.Empty;
                            }
                        }

                        if (string.IsNullOrEmpty(approver.Name))
                        {
                            someApproversMissing = true;
                            approver.Name = "<b style='color:Red;'>Sorry, the approver with the title \"" + approver.Title + "\" cannot be found!,pls. raise approver role request via <a style='color:Blue;' target=\"_blank\" href='https://forms.office.com/Pages/ResponsePage.aspx?id=I6-jEmmnVEaEf5WPPUefSm3CMyYi9HxCjpmIYzg-MA1UM0NCRkhVSklNQ0dVNldFTFdMMk0zRDI0TC4u'> SKU Registration MDR Role Application Form(office.com) </a> to fix the issue.</b>";
                        }

                        if (!string.IsNullOrEmpty(approver.Action) && !string.IsNullOrEmpty(approver.ApprovalXml) && WorkFlowAPIController.IsAdmin)
                        {
                            int WorkFlowApproverId = 0;
                            if (Int32.TryParse(approver.ApprovalXml, out WorkFlowApproverId))
                            {
                                if (WorkFlowApproverId > 0)
                                {
                                    approver.StepName += " <b onclick='rollback(" + approver.ApprovalXml + ");' title='click to rollback the work flow to this approver' style='cursor:pointer;'>[Rollback]</b>";
                                }
                            }
                        }

                        <tr id="tr@(approver.IsManuallyAdded ? approver.EmployeeId.ToString() : approver.Sequence.ToString())">
                            @*<td>@(sequence.ToString() + ".") </td>*@
                            <td>@(Html.Raw(checkResult)) @(Html.Raw(approver.StepName == "QA" ? "QA/ MS/ AG" : approver.StepName))</td>
                            <td>@(Html.Raw(approver.Title))</td>
                            <td>@(Html.Raw(approver.Name))</td>
                            <td>@(Html.Raw(approver.Action))</td>
                            <td>@(approver.Remark)</td>
                            <td>@(approver.Time)</td>
                        </tr>
                    }
                }
            }
        </table>
    </div>

    <div id="buttonDiv" class="largeOrderButtonDiv" style="margin: 0 auto; text-align: center;">
        @{
            if (!rv.IsCurrent)
            {
            }
            else if (buttonNames.Contains("Submit"))
            {
                if (rv.CreatedBy == Operation.OperationBy)
                {
                    var submitButton = buttonList.Where(k => k.EventName == "Submit");
                    if (rv.RequiredIsEmpty)
                    {
                        <button id="SubmitButton" onclick="showEmptyAlert();">
                            @(Html.Lang("Submit"))
                        </button>
                    }
                    else
                    {
                        <button id="SubmitButton" onclick="api('Submit', @(submitButton.First().EventId.ToString()), @(submitButton.First().WorkFlowId.ToString()));">
                            @(Html.Lang("Submit"))
                        </button>
                    }
                    <button onclick="editSameVersion();">
                        @(Html.Lang("Edit"))
                    </button>
                }
            }
            else if (workFlowId > 0)
            {
                foreach (Nestle.WorkFlow.Model.Button b in buttonList)
                {
                    if (b.EventName.ToLower() == "reject" || (MDC_Completed && b.EventName.ToLower() == "withdraw"))
                    {
                        continue;
                    }

                    string buttonText = b.EventName;
                    if (b.EventName.ToLower() == "ProcessInSAP".ToLower() || b.EventName.ToLower() == "SapStep".ToLower())
                    {
                        buttonText = "Complete";
                    }
                    <button onclick="api('@(b.EventName)', @(b.EventId.ToString()), @(b.WorkFlowId.ToString()));">
                        @(Html.Lang(buttonText))
                    </button>
                }
                @*if (stepName.ToLower().Contains("Trigger workflow for SDR 1st circle in SAP".ToLower()))
                {
                    <button onclick="CopyToHK(77, @(workFlowId.ToString()));">
                        @(Html.Lang("Copy For HK"))
                    </button>
                }*@
                if (buttonList.Where(k => k.EventName.ToLower() == "approve").Count() > 0)
                {
                    <button onclick="addNote(45, @(workFlowId.ToString()));">
                        @(Html.Lang("Add Note"))
                    </button>
                    @*<button onclick="forward(@(rv.Id.ToString()));">
                        @(Html.Lang("Forward"))
                    </button>*@
                }
            }

            @*if (isMDC && (Nestle.WorkFlow.Model.RequestStatus)rv.State == Nestle.WorkFlow.Model.RequestStatus.Approved)
            {
                <button onclick="showEmailDiv();">
                    @(Html.Lang("Send Email"))
                </button>
            }*@
        }
    </div>
    @if (isMDC)
    {
        <div class="main" style="clear: both;">
            @if (sapEmailList != null && sapEmailList.Count > 0)
            {
                string history = string.Empty;
                <div style="margin-bottom:15px;">
                    <select id="plant" onchange="selectPlant(this);">
                        <option value="">Select BU and Plant</option>
                        @foreach (SAPEmail item in sapEmailList)
                        {
                            if (history.Contains(item.BU + " " + item.Plant))
                            {
                                continue;
                            }

                            history += item.BU + " " + item.Plant;
                            <option value="@(item.BU + "|" + item.Plant)">@(item.BU + " " + item.Plant + " (" + item.Type + ")")</option>
                        }
                    </select>
                </div>
            }

            <div id="SAPEmailDiv">
                @{ Html.RenderPartial("PartialSAPEmail", sapEmailList); }
            </div>
        </div>
    }

    <div id="paddingDiv" style="height: 50px; clear: both;">
        &nbsp;
    </div>
</div>

<div id="EmailDiv" style="width:600px;display:none;">
    <table style="width:100%;" id="POP_Table_POPID">
        <tr>
            <td style="width:55px;">Step:</td>
            <td style="padding:6px;">
                <select class="inputfl" style="width:100%;">
                    @(CommonController.GetSelectOption("SAP_Steps", null))
                </select>
            </td>
        </tr>
        <tr>
            <td>To:</td>
            <td style="padding:6px;">
                <input type="text" class="inputfl" style="width:100%;" onchange="checkEmail(this);" />
            </td>
        </tr>
        <tr>
            <td>Cc:</td>
            <td style="padding:6px;">
                <span style="display:none;">@(Operation.Employee.Mail + ";")</span>
                <input class="inputfl" type="text" style="width:100%;" value="@(rv.Email + ";" + Operation.Employee.Mail + ";")" />
            </td>
        </tr>
        <tr>
            <td>Subject:</td>
            <td style="padding:6px;">
                <input type="text" class="inputfl" style="width:100%;" />
            </td>
        </tr>
        <tr>
            <td colspan="2" style="padding:6px;">
                <textarea class="inputfl" style="width:100%;height:250px;"></textarea>
            </td>
        </tr>
        <tr>
            <td colspan="2" style="padding:10px;text-align:center;">
                <button id="SubmitButton" onclick="send(this);">
                    @(Html.Lang("Send"))
                </button>
            </td>
        </tr>
    </table>
</div>

<script type="text/javascript">
    var requestId = @(rv.RequestId.ToString());
    var id =@(rv.Id.ToString());
    var RequestVersionState = @(rv.State);
    var MDC_Completed = "@(MDC_Completed)";
    var MDC_Input_Completed = "@(MDC_Input_Completed)";
    var Trigger_inSAP_Completed = "@(Trigger_inSAP_Completed)";
    var ReturnStepList = "@(ViewBag.ReturnStep)";
    var StepName = "@(stepName)";
    var type = "@(Model[0].RequestType.ToString())";
    function edit(workFlowId){
        location.href = "@(Url.Content("~/WriteOff?id=" + rv.Id.ToString()))";
    }

    function downloadFile(guids) {
        if (guids.indexOf(',') < 0) {
            window.open('@(Url.Content("~/Request/Download?id="))' + guids);
        }
    }

    $(function () {
        //document.getElementById("Name243").style.display = "none";
        //document.getElementById("td_243").style.display = "none";
        //document.getElementById("Name244").style.display = "none";
        //document.getElementById("td_244").style.display = "none";
        //document.getElementById("Name245").style.display = "none";
        //document.getElementById("td_245").style.display = "none";
        if (stepName == "BU Finance") {
            //if (mandatory.indexOf(",249,") >= 0) {
            document.getElementById("Name249").style.display = "none";
            document.getElementById("td_249").style.display = "none";
            document.getElementById("Name250").style.display = "none";
            document.getElementById("td_250").style.display = "none";
            document.getElementById("Name251").style.display = "none";
            document.getElementById("td_251").style.display = "none";
            document.getElementById("Name252").style.display = "none";
            document.getElementById("td_252").style.display = "none";
            document.getElementById("Name253").style.display = "none";
            document.getElementById("td_253").style.display = "none";
            document.getElementById("Name254").style.display = "none";
            document.getElementById("td_254").style.display = "none";
            document.getElementById("Name255").style.display = "none";
            document.getElementById("td_255").style.display = "none";
            //document.getElementById("Name241").style.display = "none";
            //document.getElementById("td_241").style.display = "none";
            //document.getElementById("Name242").style.display = "none";
            //document.getElementById("td_242").style.display = "none";
            document.getElementById("Name246").style.display = "none";
            document.getElementById("td_246").style.display = "none";
            document.getElementById("Name247").style.display = "none";
            document.getElementById("td_247").style.display = "none";
            document.getElementById("Name248").style.display = "none";
            document.getElementById("td_248").style.display = "none";
            document.getElementById("Name256").style.display = "none";
            document.getElementById("td_256").style.display = "none";
            document.getElementById("Name283").style.display = "none";
            document.getElementById("td_283").style.display = "none";
            document.getElementById("Name282").style.display = "none";
            document.getElementById("td_282").style.display = "none";
        }
        //var html = $("#DataTable").html();
        //if (html.indexOf("Please upload!") > 0) {
        //    alert("请上传必须的支持文件！\nPlease upload the related supporting documents!");
        //    $("#SubmitButton").hide();
        //}
    });

    function selectedIndexChanged(obj){
        if (obj.id == "Control_238")
        {
           // alert(obj.id);
            var OAProduct1 = document.getElementById(obj.id);
            var OAProduct2 = document.getElementById("Control_239");
            var Product1 = OAProduct1.options[OAProduct1.selectedIndex].value;
            Product1 = Product1.substr(0, Product1.indexOf(' '))
            OAProduct2.options.length = 0;
            $.ajax({
                type: "POST",
                url: "@(Url.Content("~/WF/GetProductClassification"))",
                data: "{Product1:'" + Product1 + "'}",
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    var json = eval(data);
                    var optionstring = "";
                    OAProduct2.add(new Option("select", ""));
                    for (var i = 0; i < json.length; i++) {
                        OAProduct2.add(new Option(json[i].ProductName, json[i].ProductName));
                    }
                },
                err: function (err) {
                }
            })
            document.getElementById("Control_239").selectedIndex = 0;
            document.getElementById("Control_240").selectedIndex = 0;
            //document.getElementById("Control_243").selectedIndex = 0;
            //document.getElementById("Control_244").selectedIndex = 0;
            //document.getElementById("Control_245").selectedIndex = 0;
            document.getElementById("Control_249").selectedIndex = 0;
            document.getElementById("Control_252").selectedIndex = 0;
            document.getElementById("Control_251").selectedIndex = 0;
            document.getElementById("Control_250").selectedIndex = 0;
            document.getElementById("Control_253").selectedIndex = 0;
            document.getElementById("Control_254").selectedIndex = 0;
            document.getElementById("Control_255").selectedIndex = 0;
            //document.getElementById("Control_241").selectedIndex = 0;
            //document.getElementById("Control_242").selectedIndex = 0;
            document.getElementById("Control_246").selectedIndex = 0;
            document.getElementById("Control_247").selectedIndex = 0;
            document.getElementById("Control_248").selectedIndex = 0;
            document.getElementById("Control_256").selectedIndex = 0;
            document.getElementById("Control_283").selectedIndex = 0;
            document.getElementById("Control_282").selectedIndex = 0;
        }

        if (obj.id == "Control_239")
        {
           // alert(obj.id);
            var OAProduct2 = document.getElementById(obj.id);
            var OAProduct3 = document.getElementById("Control_240");
            var Product2 = OAProduct2.options[OAProduct2.selectedIndex].value;
            Product2 = Product2.substr(0, Product2.indexOf(' '))
            OAProduct3.options.length = 0;
            $.ajax({
                type: "POST",
                url: "@(Url.Content("~/WF/GetProductClassification"))",
                data: "{Product1:'" + Product2 + "'}",
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    var json = eval(data);
                    var optionstring = "";
                    if (json.length == 0) {
                        OAProduct3.add(new Option(Product2 + "999", Product2 + "999"));
                    } else {
                        OAProduct3.add(new Option("select", ""));
                        for (var i = 0; i < json.length; i++) {
                            OAProduct3.add(new Option(json[i].ProductName, json[i].ProductName));
                        }
                    }
                },
                err: function (err) {
                }
            })

            var Code1 = new Array("02062", "02063", "02064", "02065", "35001", "35002", "35003");
            var Code2 = new Array("02067", "35004");
            var Code3 = new Array("08011", "08012");
            var Code4 = new Array("14005", "14009", "14006", "14007", "14060", "14061");
            var Code5 = new Array("14006", "14007", "14060", "14061");
            var Code6 = new Array("27060", "27061", "27062", "27063", "27064", "27065", "27066", "27067", "27068", "27069", "27070", "27073");
            //if (Product2 == '24004') {
            //    document.getElementById("Name243").style.display = "table-cell";
            //    document.getElementById("td_243").style.display = "table-cell";
            //    //document.getElementById("Control_243").style.display = block;
            //} else {
            //    document.getElementById("Name243").style.display = "none";
            //    document.getElementById("td_243").style.display = "none";
            //    document.getElementById("Control_243").selectedIndex = 0;
            //}
            //if (Product2 == '24061') {
            //    document.getElementById("Name244").style.display = "table-cell";
            //    document.getElementById("td_244").style.display = "table-cell";
            //} else {
            //    document.getElementById("Name244").style.display = "none";
            //    document.getElementById("td_244").style.display = "none";
            //    document.getElementById("Control_244").selectedIndex = 0;
            //}
            //if (Product2 == '24063') {
            //    document.getElementById("Name245").style.display = "table-cell";
            //    document.getElementById("td_245").style.display = "table-cell";
            //} else {
            //    document.getElementById("Name245").style.display = "none";
            //    document.getElementById("td_245").style.display = "none";
            //    document.getElementById("Control_245").selectedIndex = 0;
            //}
            if (Product2 == '18005') {
                document.getElementById("Name249").style.display = "table-cell";
                document.getElementById("td_249").style.display = "table-cell";
            } else {
                document.getElementById("Name249").style.display = "none";
                document.getElementById("td_249").style.display = "none";
                document.getElementById("Control_249").selectedIndex = 0;
            }
            if (Product2 == '21004') {
                document.getElementById("Name252").style.display = "table-cell";
                document.getElementById("td_252").style.display = "table-cell";
            } else {
                document.getElementById("Name252").style.display = "none";
                document.getElementById("td_252").style.display = "none";
                document.getElementById("Control_252").selectedIndex = 0;
            }
            if (Product2 == '21003') {
                document.getElementById("Name250").style.display = "table-cell";
                document.getElementById("td_250").style.display = "table-cell";
                document.getElementById("Name251").style.display = "table-cell";
                document.getElementById("td_251").style.display = "table-cell";
            } else if (Product2 == '21005') {
                document.getElementById("Name250").style.display = "table-cell";
                document.getElementById("td_250").style.display = "table-cell";
                document.getElementById("Name251").style.display = "none";
                document.getElementById("td_251").style.display = "none";
                document.getElementById("Control_251").selectedIndex = 0;
            } else {
                document.getElementById("Name250").style.display = "none";
                document.getElementById("td_250").style.display = "none";
                document.getElementById("Control_250").selectedIndex = 0;
                document.getElementById("Name251").style.display = "none";
                document.getElementById("td_251").style.display = "none";
                document.getElementById("Control_251").selectedIndex = 0;
            }
            if (Product2 == '21006') {
                document.getElementById("Name253").style.display = "table-cell";
                document.getElementById("td_253").style.display = "table-cell";
                document.getElementById("Name254").style.display = "table-cell";
                document.getElementById("td_254").style.display = "table-cell";
            } else {
                document.getElementById("Name253").style.display = "none";
                document.getElementById("td_253").style.display = "none";
                document.getElementById("Control_253").selectedIndex = 0;
                document.getElementById("Name254").style.display = "none";
                document.getElementById("td_254").style.display = "none";
                document.getElementById("Control_254").selectedIndex = 0;
            }
            if (Product2 == '21048') {
                document.getElementById("Name255").style.display = "table-cell";
                document.getElementById("td_255").style.display = "table-cell";
            } else {
                document.getElementById("Name255").style.display = "none";
                document.getElementById("td_255").style.display = "none";
                document.getElementById("Control_255").selectedIndex = 0;
            }
            //if (Code1.includes(Product2))
            //{
            //    document.getElementById("Name241").style.display = "table-cell";
            //    document.getElementById("td_241").style.display = "table-cell";
            //} else {
            //    document.getElementById("Name241").style.display = "none";
            //    document.getElementById("td_241").style.display = "none";
            //    document.getElementById("Control_241").selectedIndex = 0;
            //}
            //if (Code2.includes(Product2)) {
            //    document.getElementById("Name242").style.display = "table-cell";
            //    document.getElementById("td_242").style.display = "table-cell";
            //} else {
            //    document.getElementById("Name242").style.display = "none";
            //    document.getElementById("td_242").style.display = "none";
            //    document.getElementById("Control_242").selectedIndex = 0;
            //}
            if (Code3.includes(Product2)) {
                document.getElementById("Name246").style.display = "table-cell";
                document.getElementById("td_246").style.display = "table-cell";
            } else {
                document.getElementById("Name246").style.display = "none";
                document.getElementById("td_246").style.display = "none";
                document.getElementById("Control_246").selectedIndex = 0;
            }
            if (Code4.includes(Product2)) {
                document.getElementById("Name247").style.display = "table-cell";
                document.getElementById("td_247").style.display = "table-cell";
                if (Code5.includes(Product2)) {
                    document.getElementById("Name248").style.display = "table-cell";
                    document.getElementById("td_248").style.display = "table-cell";
                } else {
                    document.getElementById("Name248").style.display = "none";
                    document.getElementById("td_248").style.display = "none";
                    document.getElementById("Control_248").selectedIndex = 0;
                }
            } else {
                document.getElementById("Name247").style.display = "none";
                document.getElementById("td_247").style.display = "none";
                document.getElementById("Control_247").selectedIndex = 0;
                document.getElementById("Name248").style.display = "none";
                document.getElementById("td_248").style.display = "none";
                document.getElementById("Control_248").selectedIndex = 0;
            }
            if (Code6.includes(Product2)) {
                document.getElementById("Name256").style.display = "table-cell";
                document.getElementById("td_256").style.display = "table-cell";
                document.getElementById("Name283").style.display = "table-cell";
                document.getElementById("td_283").style.display = "table-cell";
            } else {
                document.getElementById("Name256").style.display = "none";
                document.getElementById("td_256").style.display = "none";
                document.getElementById("Control_256").selectedIndex = 0;
                document.getElementById("Name283").style.display = "none";
                document.getElementById("td_283").style.display = "none";
                document.getElementById("Control_283").selectedIndex = 0;
            }
        }
        if (obj.id == "Control_246") {
            var OAProduct1 = document.getElementById(obj.id);
            var Product1 = OAProduct1.options[OAProduct1.selectedIndex].value;
            if (Product1 == 'Sticks') {
                document.getElementById("Name282").style.display = "table-cell";
                document.getElementById("td_282").style.display = "table-cell";
            } else {
                document.getElementById("Name282").style.display = "none";
                document.getElementById("td_282").style.display = "none";
                document.getElementById("Control_282").selectedIndex = 0;
            }
        }
    }

    function printThis(id) {
        window.open('@(Url.Content("~/WF/Print?id="))' + id.toString());
    }

    function createWord(id){
        $.post(getRootUrl() + "WF/CreateWord",{id:id}, function(json){
            if(json.Error != ""){
                pop(json.Error);
                return;
            }

            location.href = getRootUrl() + json.Path;
        });
    }
</script>
<div id="specialInput" style="display:none;">
</div>
@if (stepName.ToLower().Contains("ProcessInSAP".ToLower()) && Model[0].RequestType.Contains("新建"))
{
    <script type="text/javascript">
        function showCustomerNumber() {
            var html = '';
            html += '<div>';
            html += '    经销商编号：';
            html += '    <input type="text" id="CustomerNumber" style="width:90px;"/>';
            html += '    <button onclick="saveCustomerNumber(this);">';
            html += '        保存';
            html += '    </button>';
            html += '</div>';
            pop(html, 300);
        }

        function saveCustomerNumber(btn) {
            var customerNumber = $(btn).parent().find("input")[0].value;
            var model = new Object();
            model.Id = id;
            model.CustomerNumber = customerNumber;
            var json = $.toJSON(model);
            $.post(getRootUrl() + "WF/UpdateRequest", { json: json }, function (json) {
                if (json.Success) {
                    popOK();
                }
            });
        }

        $(function () { showCustomerNumber(); });


    </script>
}

<script type="text/javascript">
    var popId = 0;
    $(document).ready(function () {
        $(".textboxValues").each(function(){
            var id = this.id;
            var textboxId = id.replace("Values", "");
            var data = "";
            var _value = $("#" + textboxId).val();
            var arr = $(this).val().split(',');
            for(var i=0;i<arr.length;i++){
                var str = arr[i];
                if(str != ""){
                    if(data != "")data += "|";
                    data += "{k:\"" + str + "\",v:\"" + str + "\"}";
                }
            }

            $("#" + textboxId).MultDropList({ data: data });
            $("#" + textboxId).val(_value);
        });
    });

    function showEmailDiv(){
        popId++;
        var popDiv = $("#EmailDiv").html().replace(/\POPID/g, popId.toString());
        pop(popDiv);
    }

    function selectPlant(select){
        var BU_Plant = $(select).val();
        if(BU_Plant != ""){
            var model = new Object();
            var arr = BU_Plant.split('|');
            model.BU = arr[0];
            model.Plant = arr[1];
            var json = $.toJSON(model);
            $.post(getRootUrl() + "WF/GetSAPEmail", {id:@(rv.RequestId.ToString()), json: json}, function(html){
                $("#SAPEmailDiv").html(html);
            });
        }
    }


    function getModelId() {
        if (globalJsonModel != null) {
            return globalJsonModel.Id;
        }

        var url = location.href;
        if (url.indexOf("?id=") > 0) {
            var id = url.substr(url.indexOf("?") + 4);
            return parseInt(id);
        }

        return 0;
    }

     $('#manager').on('click', function () {
        var workFlowRequestVersionId = getModelId();
        layer.open({
            type: 2,
            title: "Add Packagin Info",
            maxmin: false,
            shadeClose: false,
            area: ['850px', '720px'],
            //area: ['400px', '420px'],

            content: "@Url.Content("~/WF/Packaging?RequestID=")"+ workFlowRequestVersionId
        });
    });


    function saveSAPEmail(button){
        $(button).hide();
        var data = new Array();
        var tag = "checkbox";
        var checkboxArray = getCheckboxList(tag);
        if (checkboxArray != null && checkboxArray.length > 0) {
            for (var i = 0; i < checkboxArray.length; i++) {
                var obj = document.getElementById(tag + checkboxArray[i]);
                if (obj == null) continue;
                var model = new Object();
                model.SAPEmailToId = checkboxArray[i];
                model.Checked = obj.checked;
                data.push(model);
            }
        }

        if(data.length > 0){
            var json = $.toJSON(data);
            $.post(getRootUrl() + "WF/SetSAPEmail", {id:@(rv.RequestId.ToString()), json: json}, function(html){
                $("#SAPEmailDiv").html(html);
                location.href = location.href;
                //if(html.indexOf("saveSAPEmail")>0){
                //    popOK();
                //}
            });
        }
    }
</script>

@if (needAutoFixWorkFlow)
{
    <div id="buttonDiv" class="largeOrderButtonDiv" style="margin: 0 auto; text-align: center;">
        <input type="button" class="button" value="FixWorkFlow" onclick="autoFixWorkFlow();" />
    </div>
    <script type="text/javascript">
            function autoFixWorkFlow(){
                if(confirm("The work flow is not correct or up-to-date. Are you sure to fix it automatically?")){
                    var actionUrl = getRootUrl() + "WorkFlowAPI/AutoFixWorkFlow";
                    $.post(actionUrl, {requestId: @(rv.RequestId.ToString()), id: @(rv.RequestId.ToString())}, function(json){
                        if(json.Success){
                            popOK();
                            location.href = location.href;
                        }
                        else popFailure();
                    });
                }
            }
    </script>
}